# ===========================================
# GitHub Actions Workflow: Terraform Infrastructure Pipeline
# Environment: CI/CD for IaC (Infrastructure as Code)
# Description:
#   - CI: Performs Terrascan security scan, formats, validates, and plans Terraform infrastructure
#   - CD: Waits for manual approval, then executes 'terraform apply' to deploy
#   - Workflow triggers on push to the 'main' branch
# ===========================================

name: Terraform IaC Pipeline

# -------------------------------------------
# Trigger: Run workflow on push or PR to 'main' branch
# -------------------------------------------
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# -------------------------------------------
# Global Environment Variables
# -------------------------------------------
env:
  TF_PLAN_FILE: tfplan.out
  TF_VERSION: 1.14.0
  ADMIN_PUBLIC_KEY: ${{ secrets.ADMIN_PUBLIC_KEY }}

# -------------------------------------------
# Jobs Definition
# -------------------------------------------
jobs:
  # =========================================
  # Job: Checkout Source Code
  # Purpose: Prepare repository and artifacts for CI/CD jobs
  # =========================================
  checkout_code:
    name: Checkout Source Code
    runs-on: ubuntu-latest
    steps:

      # Step 1: Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # Step 2: Setup Terraform CLI
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          
      # Step 3: Upload source code artifact for downstream jobs
      - name: Archive Code for Next Jobs
        uses: actions/upload-artifact@v4
        with:
          name: source-code
          path: .
          retention-days: 1

  # =========================================
  # Job: Terrascan Security Scan
  # Purpose: Detect security and compliance issues in Terraform code
  # =========================================
  terrascan:
    name: Terrascan Security Scan
    runs-on: ubuntu-latest
    needs: [checkout_code]
    steps:
      # Step 1: Download source code artifact
      - name: Retrieve Source Code
        uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .

      # Step 2: Setup Terraform CLI
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          
      # Step 3: Configure Docker Execution for Terrascan
      - name: Run Terrascan Init and Scan
        run: |
          echo "Initializing Terrascan policies..."
          docker run --rm -v "${PWD}:${PWD}" -w "${PWD}" accurics/terrascan init
          
          echo "Starting Terrascan scan..."
          docker run --rm -v "${PWD}:${PWD}" -w "${PWD}" accurics/terrascan scan -t terraform -i -d . || true

  # =========================================
  # Job: Terraform Format Check
  # Purpose: Ensure Terraform code formatting is correct
  # =========================================
  terraform_fmt:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    needs: [terrascan]
    steps:
      # Step 1: Downloads the source code artifact.
      - name: Retrieve Source Code
        uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .

      # Step 2: Installs Terraform CLI to use formatting commands.
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          
      # Step 3: Checks if Terraform code is properly formatted; fails if formatting issues exist.
      - name: Run Terraform fmt check
        id: fmt
        run: terraform fmt -check 

  # =========================================
  # Job: Terraform Validation
  # Purpose: Validate Terraform configuration for syntax and logical correctness
  # =========================================
  terraform_validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    needs: [terraform_fmt]
    steps:
      # Step 1: Downloads the source code artifact.
      - name: Retrieve Source Code
        uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .

      # Step 2: Installs Terraform CLI for validation commands.
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          
      # Step 3: Initializes Terraform, downloads modules and providers.
      - name: Terraform Init
        run: terraform init -input=false -upgrade

      # Step 4: Checks Terraform files for syntax errors and internal consistency.
      - name: Run Terraform validate
        run: terraform validate -no-color

  # =========================================
  # Job: Terraform Plan and Deploy Infrastructure
  # Purpose: Generate an execution plan for infrastructure changes and deploy infrastructure using the previously approved plan
  # =========================================
  terraform_plan_deploy:
    name: Terraform Plan and Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [terraform_validate]
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      TF_VAR_admin_public_key: ${{ secrets.ADMIN_PUBLIC_KEY }}
      TF_VAR_CONNECTIONSTRINGS__MONGODB: ${{ secrets.CONNECTIONSTRINGS__MONGODB }}
      TF_VAR_MONGODB__DATABASENAME: ${{ secrets.MONGODB__DATABASENAME }}
      
    outputs:
      plan_id: ${{ steps.plan.outputs.id }}
    steps:
      # Step 1: Downloads the source code artifact.
      - name: Retrieve Source Code
        uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .

      # Step 2: Installs Terraform CLI for validation commands.
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          
      # Step 3: Initializes Terraform environment and modules.
      - name: Terraform Init
        run: terraform init -input=false -upgrade

      # Step 4: Authenticate before running auto-import
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Step 5: Set Azure Subscription
      - name: Set Azure Subscription
        run: az account set --subscription ${{ secrets.ARM_SUBSCRIPTION_ID }}

      # Step 6: Generates a plan file (`tfplan.out`) containing planned changes.
      - name: Run Terraform plan and save
        id: plan
        run: terraform plan -var="force_recreate=true" -input=false -out=${{ env.TF_PLAN_FILE }}

      # Step 7: Applies the infrastructure changes from the plan with auto-approval.
      - name: Execute Terraform Apply
        run: terraform apply -auto-approve ${{ env.TF_PLAN_FILE }}